# Helm Chart Release Process

> [!WARNING]
> This document was generated by AI and may not be 100% accurate.

This document explains the automated Helm chart release process for the CipherStash Proxy chart using GitHub Actions and the Chart Releaser Action.

## Overview

The chart is automatically published to GitHub Pages at `https://cipherstash.github.io/proxy` whenever changes are pushed to the `main` branch. This is achieved using the [Chart Releaser Action](https://helm.sh/docs/howto/chart_releaser_action/) which follows Helm's official best practices.

## Repository Structure

```
proxy/
├── charts/
│   └── cipherstash-proxy/          # Chart source code
│       ├── Chart.yaml
│       ├── values.yaml
│       ├── README.md
│       └── templates/
├── .github/
│   └── workflows/
│       └── release-chart.yml       # GitHub Actions workflow
└── gh-pages-README.md              # README for GitHub Pages branch
```

## How It Works

### 1. **Automated Release Trigger**
- The workflow triggers on every push to the `main` branch
- Chart Releaser Action checks for chart version changes
- If a new version is detected, it creates a GitHub release

### 2. **Release Process**
When a new chart version is pushed:

1. **GitHub Release Creation**: A new GitHub release is created with the tag format `cipherstash-proxy-{version}`
2. **Chart Packaging**: The chart is packaged into a `.tgz` file
3. **Release Assets**: The packaged chart is attached to the GitHub release
4. **Index Update**: The `index.yaml` file is updated with new chart metadata
5. **GitHub Pages**: The updated index is published to the `gh-pages` branch

### 3. **Chart Repository**
- **Repository URL**: `https://cipherstash.github.io/proxy`
- **Index File**: `https://cipherstash.github.io/proxy/index.yaml`
- **Chart Downloads**: Available as GitHub release assets

## Making a New Release

### Step 1: Update Chart Version
Edit `charts/cipherstash-proxy/Chart.yaml`:

```yaml
apiVersion: v2
name: cipherstash-proxy
version: 0.2.0  # Increment this version
appVersion: "2.1.2"  # Update if proxy image version changes
```

### Step 2: Update Documentation
- Update `charts/cipherstash-proxy/README.md` if needed
- Update `charts/cipherstash-proxy/values.yaml` comments if needed

### Step 3: Commit and Push
```bash
git add charts/cipherstash-proxy/
git commit -m "feat: release cipherstash-proxy chart v0.2.0"
git push origin main
```

### Step 4: Verify Release
1. Check the [Actions tab](https://github.com/cipherstash/proxy/actions) for workflow status
2. Verify the new [GitHub release](https://github.com/cipherstash/proxy/releases) was created
3. Test the chart from the repository:
   ```bash
   helm repo add cipherstash https://cipherstash.github.io/proxy
   helm repo update
   helm search repo cipherstash
   ```

## Version Management

### Chart Version (`version`)
- **Semantic Versioning**: Use `MAJOR.MINOR.PATCH` format
- **Increment Rules**:
  - `MAJOR`: Breaking changes to chart API or behavior
  - `MINOR`: New features, new configuration options
  - `PATCH`: Bug fixes, documentation updates

### App Version (`appVersion`)
- **Image Version**: Should match the CipherStash Proxy image tag
- **Update When**: The underlying proxy application version changes
- **Format**: Follow the proxy's versioning scheme (e.g., "2.1.2")

## Workflow Configuration

The GitHub Actions workflow (`.github/workflows/release-chart.yml`) is configured with:

- **Trigger**: Push to `main` branch
- **Permissions**: `contents: write` (required for creating releases)
- **Chart Releaser**: Uses `helm/chart-releaser-action@v1.6.0`
- **Authentication**: Uses `GITHUB_TOKEN` (automatically provided)

## GitHub Pages Setup

### Initial Setup (One-time)
1. Enable GitHub Pages in repository settings
2. Set source to "Deploy from a branch"
3. Select `gh-pages` branch as source
4. The Chart Releaser Action will create and manage this branch

### Pages Content
- **README**: Automatically uses content from `gh-pages-README.md`
- **Index**: Generated `index.yaml` with chart metadata
- **Charts**: Chart packages are linked from GitHub releases

## Usage Instructions

Users can add the repository and install charts:

```bash
# Add the repository
helm repo add cipherstash https://cipherstash.github.io/proxy

# Update repository index
helm repo update

# Search for charts
helm search repo cipherstash

# Install the chart
helm install my-proxy cipherstash/cipherstash-proxy

# Install specific version
helm install my-proxy cipherstash/cipherstash-proxy --version 0.1.0
```

## Troubleshooting

### Workflow Failures
- **Check Actions Tab**: Review workflow logs for specific errors
- **Permissions**: Ensure repository has Actions enabled
- **Token Issues**: Verify `GITHUB_TOKEN` has required permissions

### Chart Not Appearing
- **Version Check**: Ensure chart version was actually incremented
- **Workflow Status**: Verify the workflow completed successfully
- **Cache**: Run `helm repo update` to refresh local cache

### GitHub Pages Issues
- **Settings**: Verify GitHub Pages is enabled with `gh-pages` branch
- **DNS**: Pages can take a few minutes to update after changes

## Best Practices

1. **Version Increment**: Always increment chart version for changes
2. **Testing**: Test charts locally before pushing
3. **Documentation**: Update README and examples with changes
4. **Validation**: Use `helm lint` to validate chart syntax
5. **Security**: Review chart for security best practices

## Monitoring

Monitor the release process through:
- GitHub Actions workflow status
- GitHub Releases page
- GitHub Pages deployment status
- Helm repository accessibility

## References

- [Chart Releaser Action Documentation](https://helm.sh/docs/howto/chart_releaser_action/)
- [Helm Chart Best Practices](https://helm.sh/docs/chart_best_practices/)
- [GitHub Pages Documentation](https://docs.github.com/en/pages)
- [Semantic Versioning](https://semver.org/) 