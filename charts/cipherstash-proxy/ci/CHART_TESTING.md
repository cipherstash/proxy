# Chart Testing and Linting

> [!WARNING]
> This document was generated by AI and may not be 100% accurate.

This document explains the automated chart testing and linting process for the CipherStash Proxy Helm chart using [helm/chart-testing-action](https://github.com/marketplace/actions/helm-chart-testing).

## Overview

The chart testing process ensures that:
- Charts follow Helm best practices
- Chart templates render correctly
- Charts can be installed successfully in a Kubernetes cluster
- Charts pass basic connectivity tests

## Testing Workflow

### Triggers
The testing workflow (`.github/workflows/lint-test.yml`) runs on:
- **Pull Requests**: When charts are modified (`charts/**` path changes)
- **Push to main**: When chart changes are merged
- **Workflow call**: From the release workflow as a dependency

### Testing Steps

1. **Chart Discovery**: Identifies changed charts
2. **Linting**: Validates chart syntax and best practices
3. **Cluster Creation**: Spins up a kind (Kubernetes in Docker) cluster
4. **Installation**: Installs charts in the test cluster
5. **Testing**: Runs Helm tests to verify functionality

## Configuration

### Chart Testing Configuration (`.ct.yaml`)

```yaml
target-branch: main
chart-dirs:
  - charts
validate-maintainers: true
check-version-increment: true
validate-chart-schema: true
validate-yaml-schema: true
```

**Key Settings**:
- **`check-version-increment`**: Ensures chart version is bumped for changes
- **`validate-chart-schema`**: Validates Chart.yaml structure
- **`validate-yaml-schema`**: Validates values.yaml schema
- **`validate-maintainers`**: Checks maintainer information

### Test Values (`charts/cipherstash-proxy/ci/test-values.yaml`)

Test values provide minimal configuration for chart installation testing:

- **Database**: Mock database configuration
- **CipherStash**: Test credentials (non-functional)
- **Resources**: Minimal resource requests for testing
- **Services**: Simplified configuration (metrics disabled)
- **Probes**: Faster probe intervals for testing

## Chart Tests

### Connection Test (`charts/cipherstash-proxy/templates/tests/test-connection.yaml`)

A basic connectivity test that:
- Uses a `busybox` container with `wget`
- Tests connection to the proxy service
- Validates that the service is reachable
- Runs as a Helm test hook

```bash
# Manual test execution
helm test <release-name>
```

## Workflow Integration

### Lint and Test Workflow

**File**: `.github/workflows/lint-test.yml`

```yaml
name: Lint and Test Charts
on:
  pull_request:
    paths: ['charts/**']
  push:
    branches: [main]
    paths: ['charts/**']
  workflow_call:

jobs:
  lint-test:
    steps:
      - name: Set up chart-testing
      - name: Run chart-testing (list)
      - name: Run chart-testing (lint)
      - name: Create kind cluster
      - name: Run chart-testing (install)
```

### Release Workflow Integration

The release workflow depends on successful testing:

```yaml
jobs:
  lint-test:
    uses: ./.github/workflows/lint-test.yml
  
  release:
    needs: lint-test  # Only release if tests pass
```

## Local Testing

### Prerequisites

Install required tools:
```bash
# Install chart-testing
pip install chart-testing

# Install kind (for local cluster testing)
# macOS
brew install kind

# Linux
curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
chmod +x ./kind
sudo mv ./kind /usr/local/bin/kind
```

### Linting Charts

```bash
# Lint all charts
ct lint --target-branch main

# Lint specific chart
ct lint --charts charts/cipherstash-proxy

# Lint with debug output
ct lint --debug --charts charts/cipherstash-proxy
```

### Testing Chart Installation

```bash
# Create kind cluster
kind create cluster --name chart-testing

# Install and test charts
ct install --target-branch main

# Cleanup
kind delete cluster --name chart-testing
```

### Manual Chart Testing

```bash
# Install chart with test values
helm install test-proxy charts/cipherstash-proxy \
  -f charts/cipherstash-proxy/ci/test-values.yaml

# Run chart tests
helm test test-proxy

# Check test results
kubectl get pods -l "helm.sh/hook=test"

# Cleanup
helm uninstall test-proxy
```

## Test Scenarios

### 1. **Chart Linting**
- Validates Chart.yaml schema
- Checks template syntax
- Verifies best practices compliance
- Validates values.yaml schema

### 2. **Installation Testing**
- Creates temporary Kubernetes cluster
- Installs chart with test values
- Verifies all resources are created
- Checks pod readiness

### 3. **Connectivity Testing**
- Runs Helm test hooks
- Validates service connectivity
- Ensures proxy service is reachable

### 4. **Version Validation**
- Ensures chart version increment on changes
- Validates semantic versioning
- Prevents duplicate versions

## Troubleshooting

### Linting Failures

**Chart.yaml Issues**:
```bash
# Check Chart.yaml syntax
helm lint charts/cipherstash-proxy

# Validate schema
ct lint --charts charts/cipherstash-proxy --debug
```

**Template Issues**:
```bash
# Render templates
helm template charts/cipherstash-proxy \
  -f charts/cipherstash-proxy/ci/test-values.yaml

# Debug specific template
helm template charts/cipherstash-proxy \
  -f charts/cipherstash-proxy/ci/test-values.yaml \
  --debug
```

### Installation Failures

**Resource Issues**:
- Check test values provide all required configuration
- Verify resource limits are appropriate for testing
- Ensure no external dependencies in test mode

**Probe Failures**:
- Adjust probe timings in test values
- Check container startup time
- Verify service configuration

### Test Failures

**Connection Test**:
```bash
# Check test pod logs
kubectl logs -l "helm.sh/hook=test"

# Debug service
kubectl get svc
kubectl describe svc <service-name>

# Check endpoints
kubectl get endpoints
```

## Best Practices

### Chart Development
1. **Always increment chart version** when making changes
2. **Test locally** before pushing changes
3. **Keep test values minimal** but functional
4. **Add meaningful tests** for critical functionality

### CI/CD Integration
1. **Require tests to pass** before merging PRs
2. **Block releases** on test failures
3. **Monitor test performance** and optimize as needed
4. **Keep test cluster minimal** for faster execution

### Test Maintenance
1. **Update test values** when chart requirements change
2. **Add new tests** for new features
3. **Remove obsolete tests** that no longer apply
4. **Document test scenarios** and expected behavior

## Monitoring and Metrics

### GitHub Actions Metrics
- Test execution time
- Success/failure rates
- Chart coverage

### Test Performance
- Installation time
- Resource usage
- Test execution duration

## References

- [Helm Chart Testing](https://github.com/helm/chart-testing)
- [Chart Testing Action](https://github.com/marketplace/actions/helm-chart-testing)
- [Kind (Kubernetes in Docker)](https://kind.sigs.k8s.io/)
- [Helm Test Hooks](https://helm.sh/docs/topics/chart_tests/)
- [Helm Best Practices](https://helm.sh/docs/chart_best_practices/) 