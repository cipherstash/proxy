# CipherStash Proxy


Experiments in Minimally Viable Proxying.




## Dependencies


Databases are defined and configured in `tests/docker-compose.yml'

See `Docker Compose` below for details.



## Tests

Uses [mise](https://mise.jdx.dev/) and  [Nextest](https://nexte.st/) for testing.

```
cargo binstall cargo-nextest --secure
```


### Run all tests
```
  mise run test
  mise r t
```

### Run a single test
```
  mise r t {TEST_NAME}
  mise r t test_parse_destination
```



## Docker Compose

Conventions for running multiple postgres versions

The goal is to have as little to configure in local dev as possible.

### common configuration

All containers use the same credentials and database, defined in `pg/common.env`

```
POSTGRES_DB="mlp"
POSTGRES_USER="mlp"
PGUSER="mlp"
POSTGRES_PASSWORD="password"
```

### ports

All ports start with `55` followed by the `version` number
Postgres latest always runs on `5532`

```
    55{version}

    5517
```


### container_name
```
    pg-{version}
    pg-{version}-tls

    pg-17
    pg-17-tls
```


### config files
```
    ./pg/postgresql-tls.conf
    ./pg/pg_hba-tls.conf
```

Configuration is quite consistent between versions and we shouldn't need many version-specific configurations.


### data directory

Mount the data directory to access logs.

```
    .pg/data-{version}
```


## TLS

### Configuration

Turns ssl on and enforces `md5` password hashing.
- pg/postgresql-tls.conf
- pg/pg_hba-tls.conf


Uses certs generated by mkcert
- tls/localhost-key.pem
- tls/localhost-key.pem


## Commands

Connect to pg 17 over TLS
```
docker compose up --build
```

```
psql postgresql://mlp:password@localhost:5517/mlp
```



