# My Little Proxy


Experiments in Minimally Viable Proxying.

My Little Proxy connects directly to Postgres and demonstrates intercepting and rewriting `jsonb` parameters.

Supports both `binary` and `text` formats.


### But why!?

The entire codebase is about `1/5` of the size than the current pgcat `client.rs` file.


### Note
The rest of the owl needs to be drawn.


```
............................................*.......................................................
...........................................#+#......................................................
..........................................##+++..............=#.....................................
..........................................+#+###........:#+:*##.....................................
.........................................+==###+=-++++#++:+.+#......................................
........................................#+-:=#:.-=##+--++#:#*=......................................
.......................................#+:::-##::+**=-=+-*:*#.......................................
.......................................+-:.#=:.#.+*##-:#.#+#........................................
.....................................#=*:-#.:+###.+##-#=:.#+........................................
....................................-=#=.:#-+#.+**.-#*#*#.##=.......................................
....................................#-#-::*:..=-:#+#:#=-++##........................................
.....................................=*=:-#=.-+-:####:=+=###........................................
....................................=##-+:-####=:=*-.+*##*-==.......................................
...................................+##=##-+#=+*########++.-+#-......................................
..................................++#+*++-###*:+:--+==+.##==*+......................................
.................................:.###:=--=####-:::--.##..-=###.....................................
...................................-#..#:+#*.-=-=###:##...+####.....................................
..................................=+*=-###.::##----#+*--#.+##+#+....................................
..................................+##=.+=-=+-=#=..:=*##+..+#####....................................
...................................#......#+..:++:::::....:###*#....................................
...................................#=+.=-.-:..+::.:::.::-.-#####....................................
...................................#=++..=.....*+.=-:::.--.#+###....................................
...................................#=-+..:+....#..:*...-.--.####....................................
...................................==*=.+........::--......:+++#....................................
.....................................#==.-:=::......=::.=:..=-+#....................................
......................................#++..............++=:..###....................................
........................++:++++==::....-#:--:.--.--:...:.....#-.....................................
........................:::=+::+-=+++#####:...::............#+......................................
................................---+#++++#+--.............=+========:::::...:.......................
...............................:---====-:.#.#-:-:#=-.#-.#=##:::.::--*******##*******................
..............................:-*****:::-+.--=*+=#.-*.**##*##+=======######-=-:::...................
.........................====-.......-+-=+++*++=---******:-+--......................................
............................................##*::====--*#*.+:-*+==*#=####*+-====::..................
.............................................##::..:.--+.:##..............:=+*......................
..............................................#+#..++=:+.+*#........................................
...............................................#+=.=++.#+.#+........................................
................................................==**+*:+*##+........................................
..................................................+##*###*#.........................................
```


## Tests

Assumes a database called `my_little_proxy` and a `blah` table.


```sql
CREATE TABLE blah (
    id bigint GENERATED ALWAYS AS IDENTITY,
    t TEXT,
    j JSONB,
    vtha JSONB,
    PRIMARY KEY(id)
);
```

Run the proxy

```bash
cargo run
```


Run the test

```bash
cargo test -- --nocapture
```





### Sql Server

Server=localhost,1433;Database=master;User Id=SA;Password=Password1;

my-little-proxy
Server=localhost,6433;Database=master;User Id=SA;Password=Password1;


```sql
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=Password1" \
   -p 1433:1433 --name sql2022 --hostname sql2022 \
   -d \
   mcr.microsoft.com/mssql/server:2022-latest
```



IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[blah]') AND type in (N'U'))
DROP TABLE [dbo].[blah]
GO



Assuming
`mise use postgres`

```
pg_ctl start
createdb my-little-proxy -U postgres

CREATE DATABASE mlp;
CREATE USER mlp WITH ENCRYPTED PASSWORD 'password';
GRANT ALL PRIVILEGES ON DATABASE mlp TO mlp;

-- REVOKE ALL PRIVILEGES ON DATABASE mlp FROM mlp;


psql postgresql://mlp:password@127.0.0.1:5432/mlp



-- check SSL in use
SELECT datname,usename, ssl, client_addr
  FROM pg_stat_ssl
  JOIN pg_stat_activity
    ON pg_stat_ssl.pid = pg_stat_activity.pid;

```