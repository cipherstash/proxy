# CipherStash Proxy


Experiments in Minimally Viable Proxying.




## Dependencies


Databases are defined and configured in `tests/docker-compose.yml'

See `Docker Compose` below for details.

- [Bininstall](https://github.com/cargo-bins/cargo-binstall)
- [Mise](https://github.com/jdxcode/mise)
- [Nextest](https://nexte.st/)
- [Docker](https://www.docker.com/)
- [Docker Compose](https://docs.docker.com/compose/)

Install the following which is a dependency of `sqltk`:

```bash
cargo install cargo-expand
```

## Tests

Uses [mise](https://mise.jdx.dev/) and  [Nextest](https://nexte.st/) for testing.

```
cargo binstall cargo-nextest --secure
```

### Setup

Assumes running docker postgres service with default credentials

'''
  mise run setup
  mise r s
'''

### Run all tests
```
  mise run test
  mise r t
```

### Run a single test
```
  mise r t {TEST_NAME}
  mise r t load_schema
```




## Docker Compose

Conventions for running multiple postgres versions

The goal is to have as little to configure in local dev as possible.

### Run all services
```
mise r u
```

### Run a specific service
```
mise r u postgres
```

### common configuration

All containers use the same credentials and database, defined in `pg/common.env`

```
POSTGRES_DB="cipherstash"
POSTGRES_USER="cipherstash"
PGUSER="cipherstash"
POSTGRES_PASSWORD="password"
```

### ports

All ports start with `55` followed by the `version` number
Postgres latest always runs on `5532`

```
    55{version}

    5517
```


### container_name
```
    pg-{version}
    pg-{version}-tls

    pg-17
    pg-17-tls
```


### config files
```
    ./pg/postgresql-tls.conf
    ./pg/pg_hba-tls.conf
```

Configuration is quite consistent between versions and we shouldn't need many version-specific configurations.


### data directory

Mount the data directory to access logs.

```
    .pg/data-{version}
```


## TLS

### Configuration

Turns ssl on and enforces `md5` password hashing.
- pg/postgresql-tls.conf
- pg/pg_hba-tls.conf


Uses certs generated by mkcert
- tls/localhost-key.pem
- tls/localhost-key.pem


## Commands

Connect to pg 17 over TLS
```
docker compose up --build
```

```
psql postgresql://cipherstash:password@localhost:5517/cipherstash
```



