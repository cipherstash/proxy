name: Release Charts

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Chart version to release (e.g., 0.1.1) and needs to be a valid Proxy release.'
        required: true
        type: string

jobs:
  lint-test:
    uses: ./.github/workflows/lint-test-chart.yml

  release:
    needs: lint-test
    permissions:
      contents: write      # Create releases and upload chart packages
      pages: write         # Update GitHub Pages for chart repository
      id-token: write      # Required for GitHub Pages deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Update chart version
        run: |
          # Determine version source: manual input or release tag
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            CHART_VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from release tag (remove 'v' prefix if present)
            RELEASE_VERSION="${{ github.event.release.tag_name }}"
            CHART_VERSION="${RELEASE_VERSION#v}"
          fi
          
          echo "Using chart version: ${CHART_VERSION}"
          
          # Update the chart version in Chart.yaml
          sed -i "s/^version: .*/version: ${CHART_VERSION}/" charts/cipherstash-proxy/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"${CHART_VERSION}\"/" charts/cipherstash-proxy/Chart.yaml
          
          # Update the image tag in values.yaml to use the new version
          sed -i "s/^  tag: .*/  tag: \"${CHART_VERSION}\"/" charts/cipherstash-proxy/values.yaml
          
          # Commit the version update
          git add charts/cipherstash-proxy/Chart.yaml charts/cipherstash-proxy/values.yaml
          git commit -m "Update chart and image version to ${CHART_VERSION}" || true

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}" 